<html><head><title>Akka-DDD: Aggregate Root Actor</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Paweł Kaczor" /><meta name="description" content="Akka DDD/CQRS/ES framework" /><meta name="og:image" content="/akka-ddd/img/poster.png" /><meta name="og:title" content="Akka-DDD: Aggregate Root Actor" /><meta name="og:site_name" content="Akka-DDD" /><meta name="og:url" content="http://github.com/pawelkaczor/akka-ddd" /><meta name="og:type" content="website" /><meta name="og:description" content="Akka DDD/CQRS/ES framework" /><link rel="icon" type="image/png" href="/akka-ddd/img/favicon.png" /><meta name="twitter:title" content="Akka-DDD: Aggregate Root Actor" /><meta name="twitter:image" content="http://github.com/pawelkaczor/akka-dddimg/poster.png" /><meta name="twitter:description" content="Akka DDD/CQRS/ES framework" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/akka-ddd/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/akka-ddd/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/akka-ddd/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/akka-ddd/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/akka-ddd/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/akka-ddd/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/akka-ddd/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/akka-ddd/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/akka-ddd/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/akka-ddd/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/akka-ddd/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/akka-ddd/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/akka-ddd/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/akka-ddd/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/akka-ddd/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/akka-ddd/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/akka-ddd/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/akka-ddd/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/akka-ddd/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/akka-ddd/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/akka-ddd/highlight/styles/github.css" /><link rel="stylesheet" href="/akka-ddd/css/style.css" /><link rel="stylesheet" href="/akka-ddd/css/palette.css" /><link rel="stylesheet" href="/akka-ddd/css/codemirror.css" /><link rel="stylesheet" href="/akka-ddd/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/akka-ddd/" class="brand"><div class="brand-wrapper"><span>Akka-DDD</span></div></a></li> <li><a href="/akka-ddd/docs/getting-started.html" class="">Getting Started</a></li> <li><a href="/akka-ddd/docs/aggregate-root.html" class="">Aggregate Root</a> <ul class="sub_section"> <li><a href="/akka-ddd/docs/aggregate-root/logical-model" class="">Logical Model</a></li> <li><a href="/akka-ddd/docs/aggregate-root/implementation" class="">Implementation</a></li> <li><a href="/akka-ddd/docs/aggregate-root/actor" class="">Actor</a></li> <li><a href="/akka-ddd/docs/aggregate-root/configuration" class="">Configuration</a></li> <li><a href="/akka-ddd/docs/aggregate-root/testing" class="">Testing</a></li></ul></li> <li><a href="/akka-ddd/docs/process-manager.html" class="">Process Manager</a> <ul class="sub_section"> <li><a href="/akka-ddd/docs/process-manager/intro" class="">Introduction</a></li> <li><a href="/akka-ddd/docs/process-manager/impl" class="">Implementation</a></li> <li><a href="/akka-ddd/docs/process-manager/saga-pattern" class="">Saga Pattern</a></li> <li><a href="/akka-ddd/docs/process-manager/configuration" class="">Configuration</a></li> <li><a href="/akka-ddd/docs/process-manager/testing" class="">Testing</a></li></ul></li> <li><a href="/akka-ddd/docs/projections.html" class="">Projections</a></li> <li><a href="/akka-ddd/docs/reliable-messaging.html" class="">Reliable messaging</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/pawelkaczor/akka-ddd"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/pawelkaczor/akka-ddd"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Akka-DDD Akka DDD/CQRS/ES framework');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Akka-DDD Akka DDD/CQRS/ES framework');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="pawelkaczor" data-github-repo="akka-ddd"><div class="content-wrapper"><section><h2 id="aggregate-root-actor">Aggregate Root Actor</h2>

<p><a href="">Aggregate Root Actor</a> is responsible for running the Aggregate Root state machine (the AR behavior). It is a <a href="">Persistent Actor</a>.
When a <a href="">Command Messages</a> comes in, the actor invokes the current <a href="">Command Handler</a> (the Command Handler associated with the current state) and if the command is accepted, appends the <a href="">Event Message</a>(s) to the actor’s journal. Once the event message(s) is persisted, the AR actor invokes the current <a href="">Event Handler</a> (the Event Handler associated with the current state) and the AR transitions to the next state.</p>

<p>Aggregate Root Actors are not directly accessible by the clients. They are like clerks working in an office. The only way to perform an operation on a particular Aggregate Root (a business entity / case) is to submit a form (command) to the respective <a href="">Office</a>.</p>

<h3 id="aggregate-root-actor-factory">Aggregate Root Actor Factory</h3>

<p>Aggregate Root Actor Factory should provide a recipe (<a href="">Props</a>) for the Aggregate Root Actor of specified class. The supervising Office will use that recipe to create the actor. Please see an example of the AR Actor Factory below:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">ReservationARFactory</span> <span class="k">extends</span> <span class="nc">AggregateRootActorFactory</span><span class="o">[</span><span class="kt">Reservation</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">props</span><span class="o">(</span><span class="n">pc</span><span class="k">:</span> <span class="kt">PassivationConfig</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">Reservation</span><span class="o">(</span><span class="nc">DefaultConfig</span><span class="o">(</span><span class="n">pc</span><span class="o">)))</span>
  <span class="o">}</span>
</code></pre>
</div>
<p>See also: <a href="">Aggregate Root Configuration</a></p>

<h2 id="office"><a name="Office"></a>Office</h2>

<p>The office should publish its identifier to be used across the system by the service consumers and client applications.
The office identifier should allow obtaining the identifier of the office journal and the identifiers of the journals of the individual business entities (cases).</p>

<p>Akka-DDD provides the [RemoteOfficeId] class to be used for that purpose.</p>

<p>The identifier of the sample <a href="">Reservation office</a> is shown below:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nc">RemoteOfficeId</span><span class="o">(</span>
    <span class="n">id</span>           <span class="k">=</span> <span class="s">"Reservation"</span><span class="o">,</span>
    <span class="n">department</span>   <span class="k">=</span> <span class="s">"Sales"</span><span class="o">,</span>
    <span class="n">messageClass</span> <span class="k">=</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">sales.Command</span><span class="o">]</span>
<span class="o">)</span>
</code></pre>
</div>

<p>The messageClass property defines the base class of all message classes that the office is ready to handle (this information helps to auto-configure the command dispatching that is performed by the write-front application).</p>

<h3 id="office-creation">Office creation</h3>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">reservationOffice</span> <span class="k">=</span> <span class="nc">OfficeFactory</span><span class="o">.</span><span class="n">office</span><span class="o">[</span><span class="kt">Reservation</span><span class="o">]</span>
</code></pre>
</div>

<p>Assuming the <code class="highlighter-rouge">newicom.dddd.cluster</code> package object is available in the scope (the package object is imported), the actual office creation is delegated to the cluster-aware / sharding-capable <a href="">OfficeFactory</a> object that is injected automatically as an implicit argument of the <code class="highlighter-rouge">office</code> method. The office factory requires an <code class="highlighter-rouge">AR Actor Factory</code> and a shard allocation strategy to be implicitly provided for the given AR Actor class. The <code class="highlighter-rouge">Office</code> object that is eventually created contains the office identifier and the address (in the form of an ActorPath) of the office representative Actor.</p>

<h2 id="graceful-passivation">Graceful Passivation</h2>

<p>To reduce memory consumption, idle Aggregate Root Actors should be passivated (removed from the memory) after a specified inactivity timeout. To do it <a href="">safely</a> AR Actor is configured to receive <a href="">ReceiveTimeout</a> after specified inactivity period. Being notified, AR Actor asks the Office to dismiss him gracefully. The pattern/protocol is called Graceful Passivation and is supported by the Akka-DDD (see <a href="">GracefulPassivation</a> trait).</p>

<p>See also: <a href="">Passivation Configuration</a></p>

<h2 id="collaboration-with-other-actors">Collaboration with other Actors</h2>

<p>The example of collaboration implementation can be found in the <a href="">DummyAggregateRoot</a> Actor:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DummyAggregateRoot</span><span class="o">(</span><span class="n">cfg</span><span class="k">:</span> <span class="kt">DummyConfig</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AggregateRoot</span><span class="o">[</span><span class="kt">DummyEvent</span>, <span class="kt">Dummy</span>, <span class="kt">DummyAggregateRoot</span><span class="o">]</span>
    <span class="k">with</span> <span class="nc">AggregateRootLogger</span><span class="o">[</span><span class="kt">DummyEvent</span><span class="o">]</span>
    <span class="k">with</span> <span class="nc">ConfigClass</span><span class="o">[</span><span class="kt">DummyConfig</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">config</span><span class="k">:</span> <span class="kt">DummyConfig</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">valueGeneration</span> <span class="k">=</span> <span class="n">valueGeneration</span><span class="o">)</span>

  <span class="k">lazy</span> <span class="k">val</span> <span class="n">valueGeneratorActor</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">ValueGeneratorActor</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">valueGenerator</span><span class="o">))</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">valueGeneration</span><span class="k">:</span> <span class="kt">Collaboration</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">millis</span>
    <span class="o">(</span><span class="n">valueGeneratorActor</span> <span class="o">!&lt;</span> <span class="nc">GenerateRandom</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">ValueGeneratorActor</span><span class="o">.</span><span class="nc">ValueGenerated</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rejectNegative</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="n">orElse</span>
          <span class="nc">ValueGenerated</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">confirmationToken</span> <span class="k">=</span> <span class="n">uuidObj</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Reject</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">valueGeneration</span>
          <span class="k">case</span> <span class="n">r</span>         <span class="k">=&gt;</span> <span class="n">r</span>
        <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>ValueGeneratorActor is some other actor responsible for generating a random value in response to the <code class="highlighter-rouge">GenerateRandom</code> message. The Dummy Aggregate Root Actor needs to implement the interaction with the ValueGeneratorActor as a <code class="highlighter-rouge">Collaboration</code> type and expose it via the <a href="">Aggregate Root Configuration</a> interface. <code class="highlighter-rouge">Collaboration</code> is a special subtype of the <code class="highlighter-rouge">Reaction</code> type. See <a href="">Aggregate Root Implementation - Command Handling</a> for more information about the <code class="highlighter-rouge">Reaction</code>.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/akka-ddd/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'pawelkaczor/akka-ddd'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/akka-ddd/js/main.js"></script></body></html>